<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seeksmart</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        body {
            background: url('images/bg.png') no-repeat center center fixed;
            background-size: cover;
        }
        .navbar {
            background: #020079;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            margin-right: auto;
        }
        .navbar-toggler {
            margin-left: auto;
        }
        .navbar-collapse .navbar-nav .nav-link {
            color: #fff !important;
            font-size: 1.2em; /* Increase font size */
            transition: color 0.3s;
        }
        .navbar-collapse .navbar-nav .nav-link:hover {
            color: #000 !important;
        }
        .navbar-collapse {
            background-color: transparent;
        }
        .main-content {
            color: #fff;
            text-align: center;
            margin-top: 80px;
        }
        .main-content h1 {
            font-weight: 700;
            margin-bottom: 20px;
        }
        .main-content img {
            max-width: 100%;
            height: auto;
        }

        .nav-link {
            display: flex;
            align-items: center;
        }
        .nav-link svg,
        .nav-link i {
            margin-right: 5px; /* Adjust space between icon and text */
            width: 1em; /* Adjust the width to match text size */
            height: 1em; /* Adjust the height to match text size */
            vertical-align: -0.125em;
        }
        .btn-primary {
            color: #fff;
            background-color: #020079;
            border-color: #020079;
        }
        .btn-nav {
            margin-left: 10px; /* Add some spacing between buttons */
        }
        .btn-nav i {
            margin-right: 5px; /* Adjust space between icon and text */
        }
        /* Media Queries for Responsive Design */
        @media (max-width: 768px) {
            .navbar-brand img {
                width: 200px;
            }
            .main-content {
                margin-top: 40px;
            }
            .main-content h1 {
                font-size: 1.5em;
            }
            .main-content img {
                width: 80%;
                margin: 0 auto;
            }
            .navbar-collapse .navbar-nav .nav-link {
                font-size: 1em;
            }
            .btn-nav {
                margin-left: 0;
                margin-top: 10px;
            }
        }

        .modal-dialog {
            min-height: calc(100vh - 1rem); /* Adjust according to your modal content */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal form input[type="email"] {
            text-align: center; 
            color: #000000;
            font-size: 18px;
            font-weight: bold; 
        }
        .modal form input[type="email"]::placeholder {
            text-align: center; 
            color: #000000;
            font-size: 18px;
            font-weight: bold;
        }
        .modal form input[type="text"],
        .modal form input[type="password"] {
            text-align: center; 
            color: #000000;
            font-size: 18px;
            font-weight: bold; 
        }
        .modal form input[type="text"]::placeholder,
        .modal form input[type="password"]::placeholder {
            text-align: center; 
            color: #000000;
            font-size: 18px;
            font-weight: bold;
        }
        .modal-content {
            background-color: rgba(255, 255, 255, 0.7); 
            padding: 20px;
            border: 2px solid #020079;
            border-radius: 20px;
            box-shadow: 0px 5px 10px 0px rgba(0,0,0,0.2);
            animation: animatetop 0.4s;
            max-width: 90vw; /* Maximum width relative to the viewport width */
            max-height: 90vh; /* Maximum height relative to the viewport height */
            overflow-y: auto; /* Adds scroll if content exceeds the modal's height */
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        .required-asterisk:after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="images/hccslogo.png" alt="Seeksmart" width="200" height="100" class="d-inline-block align-top">
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button class="btn btn-primary btn-nav login-button" data-toggle="modal" data-target="#adminLogin">
                            <i class="fas fa-user-shield"></i> Admin Login
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-primary btn-nav register-button" data-toggle="modal" data-target="#studForm">
                            <i class="fas fa-user-graduate"></i> Student Login
                        </button>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="studentcontact.html">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-dots-fill" viewBox="0 0 16 16">
                                <path d="M16 8c0 3.866-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.584.296-1.925.864-4.181 1.234-.2.032-.352-.176-.273-.362.354-.836.674-1.95.77-2.966C.744 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7M5 8a1 1 0 1 0-2 0 1 1 0 0 0 2 0m4 0a1 1 0 1 0-2 0 1 1 0 0 0 2 0m3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                            </svg>
                            Contact Us
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-content">
        <div class="row">
            <div class="col-md-8">
                <h1>Holy Child Catholic School</h1>
                <h1>Lost and Found Management System</h1>
            </div>
            <div class="col-md-4">
                <img src="images/sslogo.png" alt="Seeksmart" class="img-fluid">
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <!-- Admin Login Modal -->
    <div id="adminLogin" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="adminLoginLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img id="loginimage" src="images/loginlogo.png" class="img-fluid mx-auto d-block" alt="Login Logo">
                    <form id="loginForm">
                        <div class="form-group">
                            <input type="text" class="form-control" id="email" name="email" placeholder="Email" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" id="password" name="password" placeholder="Password" autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Login</button>
                        <div class="text-center mt-3">
                            <a href="#" class="text-primary" data-toggle="modal" data-target="#forgotPasswordModal" data-dismiss="modal">Forgot Password?</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Student Login Modal -->
    <div id="studForm" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="studFormLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img id="loginimage" src="images/loginlogo.png" class="img-fluid mx-auto d-block" alt="Login Logo">
                    <form id="studentForm">
                        <div class="form-group">
                            <label for="studEmail">Email address <span class="required-asterisk"></span></label>
                            <input type="email" class="form-control" id="studEmail" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="studentPassword">Password <span class="required-asterisk"></span></label>
                            <input type="password" class="form-control" id="studentPassword" placeholder="Password" required pattern=".{6,16}" title="Password must be 6 to 16 characters long">
                        </div>
                        <button type="submit" class="btn btn-primary">Login</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal" data-toggle="modal" data-target="#registerModal">Register</button>
                        <div class="text-center mt-3">
                            <a href="#" class="text-primary" data-toggle="modal" data-target="#forgotPasswordModal" data-dismiss="modal">Forgot Password?</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="modal-title text-center">Reset Password</h5>
                    <form id="forgotPasswordForm">
                        <div class="form-group">
                            <input type="email" class="form-control" id="forgotEmail" placeholder="Enter your email" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Send Reset Email</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <img id="registerimage" src="images/loginlogo.png" class="img-fluid mx-auto d-block" alt="Register Logo">
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="registerEmail">Email address <span class="required-asterisk"></span></label>
                            <input type="email" class="form-control" id="registerEmail" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Password <span class="required-asterisk"></span></label>
                            <input type="password" class="form-control" id="registerPassword" placeholder="Password" required pattern=".{6,16}" title="Password must be 6 to 16 characters long">
                        </div>
                        <div class="form-group">
                            <label for="firstName">First Name <span class="required-asterisk"></span></label>
                            <input type="text" class="form-control" id="firstName" placeholder="First Name" required pattern="[A-Za-z]+" title="First Name should only contain letters">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name <span class="required-asterisk"></span></label>
                            <input type="text" class="form-control" id="lastName" placeholder="Last Name" required pattern="[A-Za-z]+" title="Last Name should only contain letters">
                        </div>
                        <div class="form-group">
                            <label for="studentId">Student ID <span class="required-asterisk"></span></label>
                            <input type="text" class="form-control" id="studentId" placeholder="Student ID" required pattern="\d+" title="Student ID should only contain numbers">
                        </div>
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase scripts -->
    <script type="module">
        // Import functions 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Web app Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDqaFeFgdypMXb8IiOGCoroURcPH0aDk8A",
            authDomain: "seeksmart-database.firebaseapp.com",
            databaseURL: "https://seeksmart-database-default-rtdb.firebaseio.com",
            projectId: "seeksmart-database",
            storageBucket: "seeksmart-database.appspot.com",
            messagingSenderId: "1066553932800",
            appId: "1:1066553932800:web:1c0d9604286191bd5f6ce5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth();

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginDate = new Date().toLocaleString();

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    if (user) {
                        const userRef = ref(database, 'adminUsers/' + user.uid);
                        get(userRef).then((snapshot) => {
                            if (!snapshot.exists()) {
                                // New user, add to database
                                set(userRef, {
                                    email: user.email,
                                    role: "admin", // Default role, change as needed
                                    lastLogin: loginDate
                                }).then(() => {
                                    alert('New user added to the database. Login again.');
                                    auth.signOut();
                                }).catch((error) => {
                                    console.error('Error adding new user:', error);
                                });
                            } else {
                                // Existing user, update login date and check role
                                const userData = snapshot.val();
                                update(userRef, { lastLogin: loginDate }).then(() => {
                                    if (userData.role === "admin") {
                                        alert('Admin logged in!');
                                        window.location.href = "dbadmin.html";
                                    } else {
                                        alert('Access denied. Admins only.');
                                        auth.signOut();
                                    }
                                }).catch((error) => {
                                    console.error('Error updating login date:', error);
                                });
                            }
                        }).catch((error) => {
                            console.error('Error fetching user data:', error);
                        });
                    } else {
                        alert('Authentication failed');
                    }
                })
                .catch((error) => {
                    const errorMessage = error.message;
                    alert(errorMessage);
                });
        });

        // Register form submission
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const studentId = document.getElementById('studentId').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    const userRef = ref(database, 'StudentUsers/' + user.uid);
                    return set(userRef, {
                        email: user.email,
                        role: "student",
                        firstName,
                        lastName,
                        studentId,
                        password,
                        lastLogin: new Date().toLocaleString()
                    });
                })
                .then(() => {
                    alert('Registration successful!');
                    $('#registerModal').modal('hide');
                    document.getElementById('registerForm').reset();
                })
                .catch((error) => {
                    console.error('Error during registration:', error);
                    alert('Registration failed: ' + error.message);
                });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const uid = user.uid;
                // Perform actions based on user state
            } else {
                // User is signed out
                // Perform actions based on user state
            }
        });

        // Student login form submission
        document.getElementById('studentForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('studEmail').value;
            const password = document.getElementById('studentPassword').value;
            const loginDate = new Date().toLocaleString();

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    const userRef = ref(database, 'StudentUsers/' + user.uid);
                    get(userRef).then((snapshot) => {
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            update(userRef, { lastLogin: loginDate }).then(() => {
                                if (userData.role === "student") {
                                    alert('Student logged in!');
                                    window.location.href = "lostitemstud.html";
                                } else {
                                    alert('Access denied. Students only.');
                                    auth.signOut();
                                }
                            }).catch((error) => {
                                console.error('Error updating login date:', error);
                            });
                        } else {
                            alert('Student not found. Please register.');
                            auth.signOut();
                        }
                    }).catch((error) => {
                        console.error('Error fetching user data:', error);
                    });
                })
                .catch((error) => {
                    alert(error.message);
                });
        });

        // Password reset form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            const actionCodeSettings = {
                url: 'https://seeksmart-database.firebaseapp.com/__/auth/action?mode=action&oobCode=code',
                handleCodeInApp: true
            };

            console.log("Sending password reset email to:", email);
            
            sendPasswordResetEmail(auth, email, actionCodeSettings)
                .then(() => {
                    console.log('Password reset email sent successfully');
                    alert('Password reset email sent! Check your inbox.');
                    $('#forgotPasswordModal').modal('hide');
                    document.getElementById('forgotPasswordForm').reset();
                })
                .catch((error) => {
                    console.error('Error sending password reset email:', error);
                    alert('Error: ' + error.message);
                });
        });

        // JavaScript to handle validation and asterisks
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', function() {
                this.previousElementSibling.querySelector('.required-asterisk').style.display = 'none';
            });

            input.addEventListener('blur', function() {
                if (this.checkValidity()) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            const firstName = document.getElementById('firstName');
            const lastName = document.getElementById('lastName');
            const password = document.getElementById('registerPassword');
            const studentId = document.getElementById('studentId');

            if (!/^[A-Za-z]+$/.test(firstName.value)) {
                e.preventDefault();
                firstName.classList.add('is-invalid');
                firstName.classList.remove('is-valid');
            }

            if (!/^[A-Za-z]+$/.test(lastName.value)) {
                e.preventDefault();
                lastName.classList.add('is-invalid');
                lastName.classList.remove('is-valid');
            }

            if (!/^.{6,16}$/.test(password.value)) {
                e.preventDefault();
                password.classList.add('is-invalid');
                password.classList.remove('is-valid');
            }

            if (!/^\d+$/.test(studentId.value)) {
                e.preventDefault();
                studentId.classList.add('is-invalid');
                studentId.classList.remove('is-valid');
            }
        });
    </script>
</body>
</html>
